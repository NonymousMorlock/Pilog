{% extends "base.html" %}

{% block title %}Pilog Â· Dashboard{% endblock %}

{% block content %}
  <h1>ðŸ›« X-Plane Logbook Dashboard</h1>

  <div class="spacer"></div>
  <form id="watcherForm" onsubmit="return false;" class="card">
    <label for="chooseFolderBtn"><strong>Choose folder to watch (contains X-Plane Pilot.txt):</strong></label>
    <button id="chooseFolderBtn" class="btn" type="button" onclick="chooseFolder()">Choose Folderâ€¦</button>
    <span id="watchedFolder" class="muted" style="margin-left: 8px;">{{ watched_folder if watched_folder else '' }}</span>
  </form>

  <form action="/" method="POST" enctype="multipart/form-data" class="card">
    <label for="logfileInput"><strong>Upload another logbook (.txt):</strong></label>
    <input id="logfileInput" type="file" name="logfile" accept=".txt" required>
    <button class="btn" type="submit">Upload</button>
  </form>

  <p>Currently viewing: <strong id="currentFilename">{{ filename }}</strong></p>
  <p>Total Flight Hours: <strong id="totalHours">{{ "%.1f"|format(data.total_hours) }}</strong> hrs</p>

  {% if flights|length == 0 %}
  <div class="card" role="status" aria-live="polite" style="margin:12px 0;">
    <div class="row" style="justify-content: space-between; align-items:center;">
      <div>
        <div style="font-weight:600;">No flights yet</div>
        <div class="muted">Choose your X-Plane logbook folder or upload a logbook file to get started.</div>
      </div>
      <div class="row">
        <button class="btn" type="button" onclick="chooseFolder()">Choose folder</button>
        <a class="btn ghost" href="#upload-start" onclick="document.getElementById('logfileInput').focus()">Upload logbook</a>
      </div>
    </div>
  </div>
  {% endif %}

  <h2>Hours per Aircraft</h2>
  {% if flights|length == 0 %}
    <div class="muted">No data yet</div>
  {% endif %}
  <canvas id="hoursByAircraft"></canvas>

  <h2>Flights per Aircraft</h2>
  {% if flights|length == 0 %}
    <div class="muted">No data yet</div>
  {% endif %}
  <canvas id="countByAircraft"></canvas>

  <h2>Flights per Route</h2>
  {% if flights|length == 0 %}
    <div class="muted">No data yet</div>
  {% endif %}
  <canvas id="routesChart"></canvas>

  <h2>Flight Hours Over Time</h2>
  {% if flights|length == 0 %}
    <div class="muted">No data yet</div>
  {% endif %}
  <canvas id="hoursOverTime"></canvas>

  <h2>Flight Log</h2>
  <div class="row" style="margin: 8px 0; align-items: center;">
    <input id="flightSearch" type="search" placeholder="Search by route, aircraft, tailâ€¦" aria-label="Search flights" style="flex:1; padding:8px; border:1px solid var(--border); border-radius:6px; background: var(--bg); color: var(--text);" />
    <div id="flightPager" class="row" style="margin-left:auto;">
      <button id="prevFlightPage" class="btn ghost" type="button">Prev</button>
      <span id="flightPageInfo" class="muted">Page 1</span>
      <button id="nextFlightPage" class="btn ghost" type="button">Next</button>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th scope="col" data-sort-key="date" aria-sort="none" style="cursor:pointer;">Date</th>
        <th scope="col" data-sort-key="dep" aria-sort="none" style="cursor:pointer;">From</th>
        <th scope="col" data-sort-key="arr" aria-sort="none" style="cursor:pointer;">To</th>
        <th scope="col" data-sort-key="hours" aria-sort="none" style="cursor:pointer;">Hours</th>
        <th scope="col" data-sort-key="aircraft" aria-sort="none" style="cursor:pointer;">Aircraft</th>
        <th scope="col" data-sort-key="tail" aria-sort="none" style="cursor:pointer;">Tail</th>
        {% if landing_available %}<th>Landing Rate</th>{% endif %}
      </tr>
    </thead>
    <tbody id="flightTableBody">
      {% for f in flights %}
      <tr>
        <td>{{ f.date }}</td>
        <td>{{ f.dep }}</td>
        <td>{{ f.arr }}</td>
        <td>{{ "%.1f"|format(f.hours) }}</td>
        <td>{{ f.aircraft }}</td>
        <td>{{ f.tail }}</td>
        {% if landing_available %}
        <td>
          {% set li = landing_index_for_flight[loop.index0] %}
          <a href="/landing-rates?date={{ f.date }}&aircraft={{ f.aircraft }}{% if li is not none %}&landingIndex={{ li }}{% endif %}" style="color:var(--link);" title="View landing rate(s) for this flight (if linked)">View</a>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script id="initialData" type="application/json">{{ data|tojson }}</script>
  <script id="initialFlights" type="application/json">{{ flights|tojson }}</script>
  <script id="initialLandingIndexMap" type="application/json">{{ landing_index_for_flight|tojson if landing_index_for_flight else '[]' }}</script>
  <script id="initialLandingAvailable" type="application/json">{{ 'true' if landing_available else 'false' }}</script>
{% endblock %}

{% block scripts %}
  <script src="/static/dashboard.js"></script>
{% endblock %}
