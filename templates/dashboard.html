<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pilog</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 2rem;
      background: #0d1117;
      color: #c9d1d9;
    }
    h1, h2 { color: #58a6ff; }
    canvas { margin: 2rem 0; max-width: 800px; }
    table { border-collapse: collapse; width: 100%; margin-top: 2rem; }
    th, td { border: 1px solid #30363d; padding: 8px; text-align: left; }
    th { background: #21262d; }
    tr:nth-child(even) { background: #161b22; }

    form {
      border: 2px dashed #30363d;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      background: #161b22;
    }
    input[type="file"] {
      background: none;
      color: #58a6ff;
      border: none;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #2ea043; }
    label { display: block; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h1>ðŸ›« X-Plane Logbook Dashboard</h1>

  <form id="watcherForm" onsubmit="return false;">
    <label for="chooseFolderBtn"><strong>Choose folder to watch (contains X-Plane Pilot.txt):</strong></label>
    <button id="chooseFolderBtn" type="button" onclick="chooseFolder()">Choose Folderâ€¦</button>
    <span id="watchedFolder" style="margin-left: 8px; color:#8b949e;">{{ watched_folder if watched_folder else '' }}</span>
  </form>

  <form action="/" method="POST" enctype="multipart/form-data">
    <label for="logfileInput"><strong>Upload another logbook (.txt):</strong></label>
    <input id="logfileInput" type="file" name="logfile" accept=".txt" required>
    <button type="submit">Upload</button>
  </form>

  <p>Currently viewing: <strong id="currentFilename">{{ filename }}</strong></p>
  <p>Total Flight Hours: <strong id="totalHours">{{ "%.1f"|format(data.total_hours) }}</strong> hrs</p>

  <h2>Hours per Aircraft</h2>
  <canvas id="hoursByAircraft"></canvas>

  <h2>Flights per Aircraft</h2>
  <canvas id="countByAircraft"></canvas>

  <h2>Flights per Route</h2>
  <canvas id="routesChart"></canvas>

  <h2>Flight Hours Over Time</h2>
  <canvas id="hoursOverTime"></canvas>

  <h2>Flight Log</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th><th>From</th><th>To</th><th>Hours</th><th>Aircraft</th><th>Tail</th>
      </tr>
    </thead>
    <tbody id="flightTableBody">
      {% for f in flights %}
      <tr>
        <td>{{ f.date }}</td>
        <td>{{ f.dep }}</td>
        <td>{{ f.arr }}</td>
        <td>{{ "%.1f"|format(f.hours) }}</td>
        <td>{{ f.aircraft }}</td>
        <td>{{ f.tail }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <script id="initialData" type="application/json">{{ data|tojson }}</script>
  <script>
    const charts = {};
    const initialData = JSON.parse(document.getElementById('initialData').textContent);

    async function chooseFolder() {
      try {
        const res = await fetch('/pick_folder', { method: 'POST' });
        const json = await res.json();
        if (!res.ok) {
          alert(json.error || 'Failed to pick folder');
          return;
        }
        const formData = new FormData();
        formData.append('folder_path', json.folder_path);
        const setRes = await fetch('/set_folder', { method: 'POST', body: formData });
        const setJson = await setRes.json();
        if (!setRes.ok) {
          alert(setJson.error || 'Failed to set folder');
          return;
        }
        document.getElementById('watchedFolder').textContent = json.folder_path;
        const dres = await fetch('/data');
        const djson = await dres.json();
        if (djson && djson.summary) {
          renderFromSummary(djson.summary);
        }
      } catch (e) {
        alert('Error choosing folder: ' + e);
      }
    }
    const createChart = (id, type, labels, values, color, horizontal=false) => {
      if (charts[id]) { try { charts[id].destroy(); } catch(_) {} }
      charts[id] = new Chart(document.getElementById(id), {
        type: type,
        data: { labels, datasets: [{ label: id, data: values, backgroundColor: color }] },
        options: { indexAxis: horizontal ? 'y' : 'x', plugins: { legend: { display: false } } }
      });
    };
    function esc(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    const renderFlightTable = (flights) => {
      try {
        const tbody = document.getElementById('flightTableBody');
        if (!tbody || !Array.isArray(flights)) return;
        tbody.innerHTML = '';
        for (const f of flights) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${esc(f.date)}</td>
            <td>${esc(f.dep)}</td>
            <td>${esc(f.arr)}</td>
            <td>${(Number(f.hours) || 0).toFixed(1)}</td>
            <td>${esc(f.aircraft)}</td>
            <td>${esc(f.tail)}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch(_) {}
    };

    const renderFromSummary = (summary) => {
      // Update header figures
      const hours = (Number(summary.total_hours) || 0).toFixed(1);
      const hoursEl = document.getElementById('totalHours');
      if (hoursEl) hoursEl.textContent = hours;
      createChart("hoursByAircraft", "bar", Object.keys(summary.flights_by_aircraft), Object.values(summary.flights_by_aircraft), "#58a6ff");
      createChart("countByAircraft", "bar", Object.keys(summary.count_by_aircraft), Object.values(summary.count_by_aircraft), "#f39c12");
      createChart("routesChart", "bar", Object.keys(summary.flights_by_route), Object.values(summary.flights_by_route), "#2ecc71", true);
      if (charts["hoursOverTime"]) { try { charts["hoursOverTime"].destroy(); } catch(_) {} }
      charts["hoursOverTime"] = new Chart(document.getElementById("hoursOverTime"), {
        type: "line",
        data: {
          labels: Object.keys(summary.flights_by_date),
          datasets: [{
            label: "Hours Flown",
            data: Object.values(summary.flights_by_date),
            borderColor: "#e74c3c",
            fill: false
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    };

    // Initial render from server-rendered data
    renderFromSummary(initialData);

    // Live updates via Socket.IO
    const socket = io();
    socket.on('log_update', (payload) => {
      if (payload && payload.summary) {
        renderFromSummary(payload.summary);
      }
      if (payload && payload.flights) {
        renderFlightTable(payload.flights);
      }
      if (payload && payload.filename) {
        const fnEl = document.getElementById('currentFilename');
        if (fnEl) fnEl.textContent = payload.filename;
      }
      if (payload && payload.watched_folder) {
        const wfEl = document.getElementById('watchedFolder');
        if (wfEl) wfEl.textContent = payload.watched_folder;
      }
    });
  </script>
</body>
</html>
